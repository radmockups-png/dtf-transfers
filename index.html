<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DTF Gang Sheet — MaxRects & Multi-Sheet</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --muted:#93a4c2; --text:#e6eefc; 
    --brand:#7c3aed; --brand-2:#06b6d4; --accent:#22c55e; 
    --danger:#ef4444; --border:#1f2a44; --chip:#111a33;
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.4 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
       background:linear-gradient(180deg,#0b1220,#0b1220 280px,#0e1628 100%)}
  header{position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border);background:rgba(11,18,32,.7);backdrop-filter:saturate(1.2) blur(8px)}
  header .inner{max-width:1240px;margin:0 auto;padding:14px 16px;display:flex;gap:12px;align-items:center}
  .title{font-weight:800;font-size:18px}
  .badge{background:linear-gradient(90deg,var(--brand),var(--brand-2));padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .subtle{color:var(--muted);font-size:12px}
  main{max-width:1240px;margin:0 auto;padding:18px;display:grid;grid-template-columns:380px 1fr 340px;gap:16px}
  @media (max-width:1100px){main{grid-template-columns:1fr}}
  .panel{background:linear-gradient(180deg,#0f172a,#0c1324);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 3px 20px rgba(0,0,0,.2)}
  .panel h3{margin:0 0 8px;font-size:14px;font-weight:800}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:1px solid var(--border);background:#0b1220;color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn:hover{border-color:#2a3a5f}
  .btn.brand{border-color:transparent;background:linear-gradient(90deg,var(--brand),var(--brand-2))}
  .btn.danger{border-color:#5b1c1c;background:#1a0f12;color:#fecaca}
  .btn.ghost{background:#0f172a}
  .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);cursor:pointer}
  .chip.active{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;border-color:transparent}
  .small{font-size:12px;color:var(--muted)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .label{font-size:11px;color:var(--muted);margin-bottom:4px}
  .input,.select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);background:#0b1220;color:var(--text);border-radius:10px;font:inherit}
  .line{height:1px;background:var(--border);margin:10px 0}
  .pill{font-size:11px;color:#cbd5e1;background:#0b1220;border:1px solid var(--border);padding:4px 8px;border-radius:999px}
  .editorWrap{background:linear-gradient(180deg,#0f172a,#0c1324);border:1px solid var(--border);border-radius:14px;padding:12px}
  .editorHead{display:flex;justify-content:space-between;margin-bottom:8px}
  .drop{position:relative;margin:0 auto;background:#0b1220;border:1px dashed #2a3a5f;border-radius:12px;overflow:hidden}
  .item{position:absolute;cursor:grab;filter:drop-shadow(0 6px 34px rgba(0,0,0,.3))}
  .item.active{outline:2px solid var(--brand-2)}
  .hint{position:absolute;inset:auto 10px 10px auto;background:rgba(12,19,36,.9);border:1px solid var(--border);color:#dbeafe;
        padding:7px 9px;border-radius:9px;font-size:11px}
  .footer{padding:14px 16px;text-align:center;color:var(--muted);font-size:12px}
  .wm{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;opacity:.18}
  .wm span{font-weight:800;font-size:48px;letter-spacing:.2em;color:#e2e8f0;mix-blend-mode:overlay}
  .sheetbar{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
<header><div class="inner">
  <div class="badge">DTF Builder</div>
  <div class="title">MaxRects Auto-Pack • Multi-Sheet</div>
  <div class="subtle">Upload → size (cm) → pack → proof → staff export</div>
</div></header>

<main>
  <!-- left controls -->
  <section class="panel">
    <h3>Sheet</h3>
    <div class="row" id="sheetButtons"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="orientBtn">Portrait</button>
      <div class="pill" id="dimLabel" style="margin-left:auto"></div>
    </div>
    <div class="line"></div>
    <h3>Upload</h3>
    <div class="row">
      <button class="btn brand" id="uploadBtn">Upload images</button>
      <input type="file" id="fileInput" accept="image/*,.svg" multiple hidden/>
      <button class="btn ghost" id="resetBtn" style="margin-left:auto">Reset</button>
    </div>
    <div class="small" style="margin-top:6px">Drag & drop or paste. Best: PNG with transparency.</div>
    <div class="line"></div>
    <h3>Packing</h3>
    <div class="row">
      <div class="label">Gutter (mm)</div>
      <input class="input" style="width:90px" type="number" id="gutterMm" min="0" step="1" value="5"/>
      <label class="row small"><input type="checkbox" id="allowRotate" checked style="margin-right:6px">Allow 90° rotation</label>
      <button class="btn" id="autoPackBtn">Auto-pack (MaxRects)</button>
    </div>
    <div class="line"></div>
    <h3>Proof</h3>
    <div class="row">
      <button class="btn" id="downloadProofBtn">Current Proof</button>
      <button class="btn" id="downloadAllProofsBtn">All Proofs</button>
    </div>
  </section>

  <!-- middle editor -->
  <section class="editorWrap">
    <div class="editorHead"><b>Editor</b><div class="subtle">Drag • Click • Nudge</div></div>
    <div class="sheetbar">
      <button class="btn" id="prevSheetBtn">⟵</button>
      <div class="pill" id="sheetIndicator">Sheet 1/1</div>
      <button class="btn" id="nextSheetBtn">⟶</button>
    </div>
    <div id="drop" class="drop" style="margin-top:8px">
      <div id="wm" class="wm" style="display:none"><span>PROOF ONLY</span></div>
      <div class="hint" id="hint">Drop files here</div>
    </div>
  </section>

  <!-- right order/staff -->
  <section class="panel">
    <h3>Order</h3>
    <div class="grid2">
      <div><div class="label">Name</div><input class="input" id="custName"/></div>
      <div><div class="label">Email</div><input class="input" id="custEmail"/></div>
      <div><div class="label">Qty</div><input class="input" id="qty" type="number" min="1" value="1"/></div>
      <div><div class="label">Finish</div>
        <select class="select" id="finish"><option>Matte</option><option>Gloss</option></select>
      </div>
    </div>
    <div class="label" style="margin-top:8px">Notes</div>
    <textarea class="input" id="notes"></textarea>
    <div class="line"></div>
    <div class="row" style="justify-content:space-between">
      <div class="small" id="priceLine">A3 £5 • A4 £3 • Roll £12</div>
      <button class="btn brand" id="placeOrderBtn">Place Order</button>
    </div>

    <!-- after order -->
    <div id="afterOrder" style="display:none">
      <div class="line"></div>
      <h3>Staff Login</h3>
      <div class="row" style="margin-bottom:8px">
        <input class="input" id="staffPinInput" type="password" placeholder="Enter Staff PIN" style="flex:1"/>
        <button class="btn brand" id="staffUnlockBtn">Unlock</button>
      </div>
      <div class="small" id="staffMsg">Production locked until staff enters PIN.</div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="exportProdBtn" disabled>Export Current (300 DPI)</button>
        <button class="btn" id="exportAllProdBtn" disabled>Export ALL Sheets (300 DPI)</button>
      </div>
    </div>
  </section>
</main>

<div class="footer">Proofs 150DPI + watermark. Production 300DPI requires staff PIN.</div>

<script>
/* constants */
const MM_PER_INCH=25.4,DPI=300,PROOF_DPI=150;
const SHEETS={A4:{mm:{w:210,h:297},price:3},A3:{mm:{w:297,h:420},price:5},ROLL:{mm:{w:330,h:1000},price:12}};
function mmToPx(mm,proof=false){return Math.round(mm*(proof?PROOF_DPI:DPI)/MM_PER_INCH);}
function cmToMm(c){return c*10;} function mmToCm(m){return m/10;}
function clamp(v,a,b){return Math.max(a,Math.min(v,b));} function uid(){return Date.now()+"_"+Math.random().toString(36).slice(2,7);}

/* state */
let sheetKey='A3',landscape=false,items=[],currentSheetIndex=0,totalSheets=1,orderPlaced=false,staffMode=false,orderId=null;

/* elements */
const drop=document.getElementById('drop'),wmEl=document.getElementById('wm'),hint=document.getElementById('hint');
const sheetButtons=document.getElementById('sheetButtons'),orientBtn=document.getElementById('orientBtn'),dimLabel=document.getElementById('dimLabel');
const uploadBtn=document.getElementById('uploadBtn'),fileInput=document.getElementById('fileInput'),resetBtn=document.getElementById('resetBtn');
const autoPackBtn=document.getElementById('autoPackBtn'),gutterMmEl=document.getElementById('gutterMm'),allowRotateEl=document.getElementById('allowRotate');
const downloadProofBtn=document.getElementById('downloadProofBtn'),downloadAllProofsBtn=document.getElementById('downloadAllProofsBtn');
const placeOrderBtn=document.getElementById('placeOrderBtn'),afterOrder=document.getElementById('afterOrder');
const exportProdBtn=document.getElementById('exportProdBtn'),exportAllProdBtn=document.getElementById('exportAllProdBtn');
const staffPinInput=document.getElementById('staffPinInput'),staffUnlockBtn=document.getElementById('staffUnlockBtn'),staffMsg=document.getElementById('staffMsg');
const sheetIndicator=document.getElementById('sheetIndicator');
const prevSheetBtn=document.getElementById('prevSheetBtn'),nextSheetBtn=document.getElementById('nextSheetBtn');
const custName=document.getElementById('custName'),custEmail=document.getElementById('custEmail'),qtyEl=document.getElementById('qty'),finishEl=document.getElementById('finish'),notes=document.getElementById('notes'),priceLine=document.getElementById('priceLine');

/* helpers */
function sheetMm(){const s=SHEETS[sheetKey].mm;return landscape?{w:s.h,h:s.w}:s;}

/* upload */
uploadBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{[...e.target.files].forEach(addFile);}
function addFile(f){const url=URL.createObjectURL(f),img=new Image();img.onload=()=>{items.push({id:uid(),name:f.name,src:url,img,wMm:(img.width/DPI*MM_PER_INCH),hMm:(img.height/DPI*MM_PER_INCH),xMm:5,yMm:5,sheet:0,mirrored:false});render();};img.src=url;}

/* reset */
resetBtn.onclick=()=>{items=[];currentSheetIndex=0;render();}

/* packing with MaxRects */
class MaxRectsBin{constructor(w,h){this.w=w;this.h=h;this.free=[{x:0,y:0,w,h}];}
 insert(W,H,rotOk){let best=null;for(const r of this.free){if(W<=r.w&&H<=r.h){best={x:r.x,y:r.y,w:W,h:H,rot:false};break;}if(rotOk&&H<=r.w&&W<=r.h){best={x:r.x,y:r.y,w:H,h:W,rot:true};break;}}if(!best)return null;this.free=[];this.free.push({x:best.x+best.w,y:best.y,w:this.w-(best.x+best.w),h:best.h});this.free.push({x:best.x,y:best.y+best.h,w:best.w,h:this.h-(best.y+best.h)});return best;}}
autoPackBtn.onclick=()=>{const s=sheetMm(),g=+gutterMmEl.value,rot=allowRotateEl.checked;items.sort((a,b)=>b.wMm*b.hMm-a.wMm*a.hMm);let bins=[new MaxRectsBin(s.w,s.h)],si=0;for(const it of items){let placed=bins[si].insert(it.wMm+g,it.hMm+g,rot);if(!placed){bins.push(new MaxRectsBin(s.w,s.h));si++;placed=bins[si].insert(it.wMm+g,it.hMm+g,rot);}it.sheet=si;it.xMm=placed.x+g/2;it.yMm=placed.y+g/2;if(placed.rot){[it.wMm,it.hMm]=[it.hMm,it.wMm];}}totalSheets=bins.length;currentSheetIndex=0;render();}

/* export */
function exportSheet(idx,proof){const s=sheetMm(),w=mmToPx(s.w,!proof),h=mmToPx(s.h,!proof),c=document.createElement('canvas');c.width=w;c.height=h;const ctx=c.getContext('2d');items.filter(it=>it.sheet===idx).forEach(it=>{ctx.drawImage(it.img,(it.xMm/s.w)*w,(it.yMm/s.h)*h,(it.wMm/s.w)*w,(it.hMm/s.h)*h);});if(proof){ctx.globalAlpha=0.2;ctx.font=`${w*0.08}px Arial`;ctx.textAlign="center";ctx.fillText("PROOF ONLY",w/2,h/2);}const a=document.createElement('a');a.href=c.toDataURL();a.download=`${proof?"proof":"prod"}_${idx+1}.png`;a.click();}
downloadProofBtn.onclick=()=>exportSheet(currentSheetIndex,true);
downloadAllProofsBtn.onclick=()=>{for(let i=0;i<totalSheets;i++)exportSheet(i,true);};
exportProdBtn.onclick=()=>exportSheet(currentSheetIndex,false);
exportAllProdBtn.onclick=()=>{for(let i=0;i<totalSheets;i++)exportSheet(i,false);};

/* order + staff unlock */
placeOrderBtn.onclick=()=>{orderPlaced=true;afterOrder.style.display="block";wmEl.style.display="grid";alert("Order placed. Staff must unlock for production export.");}
staffUnlockBtn.onclick=()=>{const STAFF_PIN="4312";if(staffPinInput.value.trim()===STAFF_PIN){staffMode=true;exportProdBtn.disabled=false;exportAllProdBtn.disabled=false;staffMsg.textContent="✅ Staff mode enabled.";staffMsg.style.color="var(--accent)";wmEl.style.display="none";}else{staffMsg.textContent="❌ Incorrect PIN.";staffMsg.style.color="var(--danger)";}}

/* render */
function render(){const s=sheetMm();drop.style.width=(s.w*2)+"px";drop.style.height=(s.h*2)+"px";drop.querySelectorAll("img").forEach(n=>n.remove());items.filter(it=>it.sheet===currentSheetIndex).forEach(it
